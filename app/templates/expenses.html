{% extends "base.html" %}

{% block title %}Expenses - Expense Tracker{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-receipt"></i> Expenses</h1>
    <button class="btn btn-primary" onclick="openModal('expenseModal')">
        <i class="fas fa-plus"></i> Add Expense
    </button>
</div>

<div class="expenses-page">
    {% if expenses %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Payment Method</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
            <tr>
                <td>{{ expense.date }}</td>
                <td><span class="category-badge">{{ expense.category }}</span></td>
                <td>{{ expense.description }}</td>
                <td class="amount">₹{{ "%.2f"|format(expense.amount) }}</td>
                <td>{{ expense.payment_method }}</td>
                <td>{{ expense.notes }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data-card">
        <i class="fas fa-receipt"></i>
        <p>No expenses recorded yet.</p>
        <button class="btn btn-primary" onclick="openModal('expenseModal')">
            <i class="fas fa-plus"></i> Add Your First Expense
        </button>
    </div>
    {% endif %}
</div>

<!-- Add Expense Modal -->
<div id="expenseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('expenseModal')">&times;</span>
        <h2><i class="fas fa-receipt"></i> Add Expense</h2>
        <form id="expenseForm">
            <div class="form-group">
                <label for="expenseDate">Date</label>
                <input type="date" id="expenseDate" required>
            </div>
            <div class="form-group">
                <label for="expenseCategory">Category</label>
                <select id="expenseCategory" required>
                    {% for category in categories %}
                    <option value="{{ category }}">{{ category }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="expenseDescription">Description</label>
                <input type="text" id="expenseDescription" required>
            </div>
            <div class="form-group">
                <label for="expenseAmount">Amount (₹)</label>
                <input type="number" id="expenseAmount" step="0.01" required>
            </div>
            <div class="form-group">
                <label for="expensePayment">Payment Method</label>
                <select id="expensePayment" required>
                    <option value="Cash">Cash</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="UPI">UPI</option>
                    <option value="Net Banking">Net Banking</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="expenseNotes">Notes</label>
                <textarea id="expenseNotes" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Add Expense</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('expenseDate').valueAsDate = new Date();

document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
        date: document.getElementById('expenseDate').value,
        category: document.getElementById('expenseCategory').value,
        description: document.getElementById('expenseDescription').value,
        amount: document.getElementById('expenseAmount').value,
        payment_method: document.getElementById('expensePayment').value,
        notes: document.getElementById('expenseNotes').value
    };

    try {
        const response = await fetch('/api/add_expense', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            closeModal('expenseModal');
            location.reload();
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        alert('An error occurred. Please try again.');
    }
});
</script>
{% endblock %}
